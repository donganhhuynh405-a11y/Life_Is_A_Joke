"""
Integration test: demo all bot components working together.
Runs a mock trading session without connecting to real exchanges.
"""
import asyncio
import sys
import os
sys.path.insert(0, os.path.abspath(os.path.join(os.path.dirname(__file__), '..')))

from src.data_fetcher import DataFetcher
from src.predictor import HybridPredictor
from src.sentiment import SentimentAnalyzer
from src.risk_manager import RiskManager
from src.executor import Executor
from src.optimizer import Optimizer
from src.reporter import Reporter
from src.health_monitor import HealthMonitor
from src.ml_models import PricePredictorLSTM, TransformerPredictor
from src.sentiment_advanced import BERTSentimentAnalyzer
from src.advanced_risk import RLPortfolioManager
import logging

logging.basicConfig(level=logging.INFO, format='%(asctime)s [%(name)s] %(message)s')
logger = logging.getLogger('integration_test')

async def integration_demo():
    """Run integrated demo of all services"""
    
    logger.info('=== Bot Integration Demo ===')
    
    # Mock config
    cfg = {
        'env': 'test',
        'exchanges': ['binance', 'bybit'],
        'symbols': {'spot': ['BTCUSDT', 'ETHUSDT']},
        'report': {'output_dir': './reports'}
    }
    
    # 1. Health Monitor
    logger.info('Starting HealthMonitor...')
    health = HealthMonitor(cfg)
    await health.start()
    
    # 2. Data Fetcher
    logger.info('Starting DataFetcher...')
    df = DataFetcher(cfg)
    await df.start()
    
    # 3. Sentiment Analyzer
    logger.info('Starting SentimentAnalyzer...')
    sentiment_svc = SentimentAnalyzer(cfg)
    await sentiment_svc.start()
    
    # 4. ML Predictor
    logger.info('Starting Predictor...')
    pred = HybridPredictor(cfg)
    await pred.start()
    
    # 5. Risk Manager
    logger.info('Starting RiskManager...')
    risk = RiskManager(cfg)
    await risk.start()
    
    # 6. Executor
    logger.info('Starting Executor...')
    executor = Executor(cfg)
    await executor.start()
    
    # 7. Optimizer
    logger.info('Starting Optimizer...')
    opt = Optimizer(cfg)
    await opt.start()
    
    # 8. Reporter
    logger.info('Starting Reporter...')
    reporter = Reporter(cfg)
    await reporter.start()
    
    await asyncio.sleep(2)
    
    # Demonstrate advanced components
    logger.info('\n=== Advanced ML & Risk Management Demo ===')
    
    # ML Ensemble Prediction
    import numpy as np
    lstm_model = PricePredictorLSTM()
    mock_features = np.random.randn(50, 10)
    pred_result = lstm_model.predict(mock_features[:10].reshape(10, 1, 10))
    logger.info('LSTM Prediction shape: %s', pred_result.shape)
    
    # Sentiment Analysis
    bert = BERTSentimentAnalyzer()
    sample_texts = [
        'Bitcoin breaking ATH - BULLISH!',
        'Market crash - everything dumping',
        'Stable price movement'
    ]
    sentiments = bert.batch_analyze(sample_texts)
    for s in sentiments:
        logger.info('Sentiment: %s -> %s', s['text'], s['label'])
    
    # Advanced Risk Management
    adv_risk = RLPortfolioManager(asset_count=2)
    portfolio = np.array([0.5, 0.5])  # 50% BTC, 50% ETH
    market_conditions = {'volatility': 0.3, 'trend': 0.5}
    rebalanced = adv_risk.rebalance(portfolio, market_conditions)
    logger.info('Portfolio rebalanced: %s', rebalanced)
    
    # Sample trade execution
    logger.info('\n=== Sample Trade Execution ===')
    logger.info('BUY signal confidence: 0.85')
    logger.info('Position size: $2500 (Kelly criterion)')
    logger.info('Leverage: 3x (ATR-adjusted)')
    logger.info('Placing order BTCUSDT market buy...')
    logger.info('✓ Order placed, trade #1234')
    
    # Sample weekly report
    logger.info('\n=== Weekly Report Summary ===')
    metrics = {
        'PnL_total': 2847.50,
        'PnL_weekly': 842.35,
        'Sharpe': 3.24,
        'MaxDrawdown': 3.8,
        'WinRate': 72.5,
        'ProfitFactor': 2.15,
        'Trades': 148
    }
    logger.info('Weekly Metrics: %s', metrics)
    pdf_path = reporter.generate_weekly_report(metrics, [])
    logger.info('Report generated: %s', pdf_path)
    
    # Shutdown
    logger.info('\n=== Shutting down services ===')
    await df.stop()
    await sentiment_svc.stop()
    await pred.stop()
    await opt.stop()
    await risk.stop()
    await executor.stop()
    await health.stop()
    
    logger.info('✓ All services stopped gracefully')
    logger.info('=== Demo Complete ===')

if __name__ == '__main__':
    asyncio.run(integration_demo())
